<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <client_script><![CDATA[function($scope, $window, spUtil, $timeout) {
	/* widget controller */
	var c = this;
	c.data.user = {};
	c.completed = true;
	c.submitted = false;

	$scope.user = {
		displayValue: c.data.user.name,
		value: c.data.user.sys_id,
		name: 'user'
	};

	$scope.$on("field.change", function(event, data) {
		c.data.userId = data.newValue;
		if (data.field.name == 'user') {
			c.server.get({
				action: 'getUser',
				userId: data.newValue
			}).then(function(r) {
				var dept = r.data.userInfo.department,
					mngr = r.data.userInfo.manager;
				c.data.department = dept ? dept : 'N/A';
				c.data.manager = mngr ? mngr : 'N/A';
			});
		}
	});


	c.submitForm = function(isValid) {
		if (isValid){
			c.submitted = true;
			c.server.get({
				action: 'submitForm',
				userId: c.data.userId,
				keyResult: c.data.keyResult.value,
				recognition: c.data.Recognition
			}).then(function(r) {
				$timeout(function() {
					$window.location.href="?id=rec_list";
				}, 2500, false);
			});	
		} else {
			spUtil.addErrorMessage('Please complete the required fields');
		}
	}; 
}

]]></client_script>
        <controller_as>c</controller_as>
        <css>form {&#13;
  margin-top: 20px;&#13;
  font-size: 14.4px;&#13;
}&#13;
&#13;
input, textarea, select {&#13;
  width: 100%;&#13;
  padding: 5px;&#13;
  border-style: solid;&#13;
  border-width: 1px;&#13;
  border-radius: 4px;&#13;
  border-color: rgb(189, 192, 196);&#13;
}&#13;
&#13;
input, select, .select2-choice {&#13;
  margin-bottom: 15px;&#13;
}&#13;
&#13;
textarea {&#13;
  resize: vertical;&#13;
}&#13;
&#13;
button {&#13;
  margin-top: 15px;&#13;
}&#13;
&#13;
.required::before {&#13;
	content: '*';&#13;
  color: red;&#13;
  margin-right: 2px;&#13;
}&#13;
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id/>
        <internal>false</internal>
        <link/>
        <name>Copy of Recognition Form</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
	var nomineePts = 5,
			nominatorPts = 1;

	/* populate the 'data' object */
	/* e.g., data.table = $sp.getValue('table'); */
	data.keyResults = [];
	var keyResultsGR = new GlideRecord('sys_choice');
	keyResultsGR.addQuery('name', 'x_thimi_imt_rec_imt_recognition');
	keyResultsGR.addQuery('element', 'key_result');
	keyResultsGR.addQuery('inactive', false);
	keyResultsGR.query();
	while (keyResultsGR.next()) {
		var kRes = {};
		kRes.name = keyResultsGR.label.toString();
		kRes.value = keyResultsGR.value.toString();
		data.keyResults.push(kRes); 
	}


	if (input) {
		if (input.action == 'getUser') {
			var userGR = new GlideRecord('sys_user');
			if (userGR.get(input.userId)) {
				data.userInfo = {};
				$sp.getRecordDisplayValues(data.userInfo, userGR, 'sys_id,manager,department');
			}
		}
		if (input.action == 'submitForm') {
			var empRec = createNomineeRecord();
			createNomatorRecord(empRec.number);
			gs.addInfoMessage('Thank you for recognizing ' + empRec.employee.getDisplayValue());
		}
	}

	function createNomineeRecord() {
		var empRec = new GlideRecord('x_thimi_imt_rec_imt_recognition');
		empRec.newRecord();
		empRec.sub_type = 'Recognition';
		empRec.nominator = gs.getUserID();
		empRec.employee = input.userId;
		var userRec = new GlideRecord('sys_user');
		if (userRec.get(input.userId)) {
			empRec.department = userRec.department;
		}
		empRec.key_result = input.keyResult;
		empRec.description = input.recognition;
		empRec.points = nomineePts;
		empRec.insert();
		return empRec;
	}

	function createNomatorRecord(number) {
		var empRec = new GlideRecord('x_thimi_imt_rec_imt_recognition');
		empRec.newRecord();
		empRec.sub_type = 'Participation';
		empRec.employee = gs.getUserID();
		var userRec = new GlideRecord('sys_user');
		if (userRec.get(gs.getUserID())) {
			empRec.department = userRec.department;
		}		
		empRec.description = number;
		empRec.points = nominatorPts;
		empRec.insert();
	}

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>isabellee</sys_created_by>
        <sys_created_on>2018-09-11 21:30:26</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>04da63a00fa46b0062b6e64be1050e0b</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Copy of Recognition Form</sys_name>
        <sys_package display_value="IMT Recognition" source="x_thimi_imt_rec">e93694ab0f279b8062b6e64be1050e59</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="IMT Recognition">e93694ab0f279b8062b6e64be1050e59</sys_scope>
        <sys_update_name>sp_widget_04da63a00fa46b0062b6e64be1050e0b</sys_update_name>
        <sys_updated_by>isabellee</sys_updated_by>
        <sys_updated_on>2018-09-11 21:30:26</sys_updated_on>
        <template><![CDATA[<div>
    <form name='giveRec' ng-submit="c.submitForm(giveRec.$valid)" ng-show="c.completed" novalidate>
        <label for='user' class="required">Select Employee</label>
        <sn-record-picker id="user" name="user" field="user" table="'sys_user'" display-field="'name'" value-field="'sys_id'" search-fields="'name'" page-size="100" default-query="'active=true^u_lob=Corporate - IT'" required>
        </sn-record-picker>
        <label for='department'>Nominee's Department</label>
        <input id='department' name='department' type='text' ng-model='c.data.department' disabled><br>
        <label for='manager'>Nominee's Manager</label>
        <input id='manager' name='manager' type='text' ng-model='c.data.manager' disabled><br>
        <label for='key_result' class='required'>Key Result</label>
        <select id='key_result' ng-options='item.name for item in c.data.keyResults track by item.value' ng-model='c.data.keyResult' required></select>
        <label for='recognition' class='required'>Recognition</label>
        <textarea id='recognition' rows='4' ng-model='c.data.Recognition' required></textarea><br>
        <button title="Add attachment" class="btn btn-link pull-left" role="button">
          <span class='glyphicon glyphicon-paperclip'></span>
                       </button>
        <button type='submit' class='btn btn-danger pull-right' ng-disabled="giveRec.$invalid || c.submitted">Submit</button>
    </form>
  	<li><sp-attachment-button ng-if="::data.canWrite && data.canAttach"></sp-attachment-button></li>
    <div ng-show="!c.completed">
        Thank you for recognizing {{ c.recognized }}!
    </div>
</div>]]></template>
    </sp_widget>
</record_update>
